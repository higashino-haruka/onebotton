#pragma once
#include"Object.h"
#include"input.h"
#include"sound.h"

#define STAGE_X (10)  //横のマス数
#define STAGE_Y (20)  //縦のマス数
#define BLOCK_SIZE (22)  //1マスのサイズ

class Game
{
private:
	// (1) ブロック着色のため追加　Add this to colour blocks
	// 各ブロックの情報用構造体　Structure for each block's attribute
	struct BLOCK_INFO
	{
		short state;	// 状態
		short tetriminoType;	// テトリミノの種類
	};

	BLOCK_INFO m_data[STAGE_X][STAGE_Y + 3] = {};  //データ配列

	Input input;
	Sound sound;

	Object m_player;  //プレイヤーオブジェクト
	Object m_hiyoko;  //ヒヨコオブジェクト
	Object m_background;   //エネミーオブジェクト
	Object m_tori;  //とりオブジェクト
	Object m_blocks[STAGE_X][STAGE_Y];  //テトリミノオブジェクト
	Object m_scoreboard; //スコアオブジェクト
	Object m_title;  //タイトルオブジェクト
	Object m_gameover;  //ゲームオーバーオブジェクト


	// Hold (ホールド)関連
	int m_holdType = -1; // -1: 空
	bool m_holdUsed = false; // 今ターンでホールドしたか（設置まで再使用不可）

	Object m_holdFrame; // ホールド枠表示用
	Object m_holdBlocks[4][4]; // ホールド中ミノの小さいブロック描画用

	// ホールド処理の宣言
	void HoldTetromino();

	// Next (次ミノ) 管理
	int m_nextCount = 3;           // 画面に表示する個数（必要なら変更可）
	int m_nextTypes[5];            // 次ミノキュー（m_nextCount より大きめに確保）

	Object m_nextFrame;//NEXT枠表示用
	Object m_nextBlocks[3][4][4];  // 描画用：プレビュー個数 x 4x4 ブロック

	void FillNextQueue();          // キューを補充する関数
	int PopNextType();             // キューから取り出す（消費する）


	int m_count = 0;  //自動落下のカウント

	int m_currentX;  //現在落下中のテトリミノの左上位置X
	int m_currentY;  //現在落下中のテトリミノの左上位置Y
	int m_currentType;  //現在落下中のテトリミノの種類(0〜6)
	int m_currentDir;  //現在落下中のテトリミノの向き(0〜3)

	int m_state = 0;  //ゲームの状態(０：落下するものがない状態、１：落下中、２：揃った状態)
	int m_score = 0;  //得点
	int m_scene = 0;  //シーン(０：タイトル、１：ゲーム本編)
	int m_next_scene = -1; // ゲームの次の状態を設定する（-1:設定なし、それ以外はm_sceneと共通）

	int m_tetrominoData[7][4][4][4] =
	{
		//直線(Iミノ)
		{
			{//0
				{0,0,0,0,},
				{2,2,2,2,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,0,2,0,},
				{0,0,2,0,},
				{0,0,2,0,},
				{0,0,2,0,},
			},
			{//2
				{0,0,0,0,},
				{0,0,0,0,},
				{2,2,2,2,},
				{0,0,0,0,},
			},
			{//3
				{0,2,0,0,},
				{0,2,0,0,},
				{0,2,0,0,},
				{0,2,0,0,},
			},
		},

		//四角(Oミノ)
		{
			{//0
				{0,0,0,0,},
				{0,2,2,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
			{//1
				{0,0,0,0,},
				{0,2,2,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{0,2,2,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
			{//3
				{0,0,0,0,},
				{0,2,2,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
		},

		//S字(Sミノ)
		{
			{//0
				{0,2,2,0,},
				{2,2,0,0,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,2,0,0,},
				{0,2,2,0,},
				{0,0,2,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{0,2,2,0,},
				{2,2,0,0,},
				{0,0,0,0,},
			},
			{//3
				{2,0,0,0,},
				{2,2,0,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
		},

		//逆Sミノ(Zミノ)
		{
			{//0
				{2,2,0,0,},
				{0,2,2,0,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,0,2,0,},
				{0,2,2,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{2,2,0,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
			{//3
				{0,2,0,0,},
				{2,2,0,0,},
				{2,0,0,0,},
				{0,0,0,0,},
			},
		},

		//逆Lミノ(Jミノ)
		{
			{//0
				{2,0,0,0,},
				{2,2,2,0,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,2,2,0,},
				{0,2,0,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{2,2,2,0,},
				{0,0,2,0,},
				{0,0,0,0,},
			},
			{//3
				{0,2,0,0,},
				{0,2,0,0,},
				{2,2,0,0,},
				{0,0,0,0,},
			},
		},

		//Lミノ(Lミノ)
		{
			{//0
				{0,0,2,0,},
				{2,2,2,0,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,2,0,0,},
				{0,2,0,0,},
				{0,2,2,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{2,2,2,0,},
				{2,0,0,0,},
				{0,0,0,0,},
			},
			{//3
				{2,2,0,0,},
				{0,2,0,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},

		},

		//T字(Tミノ)
		{
			{//0
				{0,2,0,0,},
				{2,2,2,0,},
				{0,0,0,0,},
				{0,0,0,0,},
			},
			{//1
				{0,2,0,0,},
				{0,2,2,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
			{//2
				{0,0,0,0,},
				{2,2,2,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
			{//3
				{0,2,0,0,},
				{2,2,0,0,},
				{0,2,0,0,},
				{0,0,0,0,},
			},
		},
	};



	void DropTetromino(void);  //テトリミノ落下
	void MoveTetromino(int dirX);  //テトリミノ左右移動
	void RotateTetromino(void);  //テトリミノ回転
	void DeleteTetromino(void);  //テトリミノ消去
	void CheckGameOver(void);  //ゲームオーバーか確認
	bool IsInvalidMove(int dirX, int dirY);  //テトリミノを動かすことができるか確認
	void ShiftTetrimino(int dirX, int dirY);  //m_dataを更新してテトリミノを移動させる
	// 画面遷移修正のため追加
	void ApplySceneTransition(); // 画面遷移を適用

public:
	void Init(HWND hWnd);  //初期化
	void Update(void);     //更新
	void Draw(void);          //描画
	void Uninit(void);        //終了
};
